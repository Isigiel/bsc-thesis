# Fibonacci

## Compilation
`emcc -g0 -O3 -s SIDE_MODULE=1 -s STRICT=1 -s WASM=1 -o binom.c.wasm binom.c`

## Converting for C consumption
`xxd -i binom.c.wasm` creates the conetnts of the wasm module header file

### C-code
```c++
uint32_t binomial(uint32_t n, uint32_t m) {
    if (m != 0 && n != m) {
        return binomial(n - 1, m) + binomial(n - 1, m - 1);
    } else {
        return 1;
    }
}
```

### WASM-module
```c++
unsigned char binom_c_wasm[] = {
        0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x06, 0x64,
        0x79, 0x6c, 0x69, 0x6e, 0x6b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0a,
        0x02, 0x60, 0x00, 0x00, 0x60, 0x02, 0x7f, 0x7f, 0x01, 0x7f, 0x03, 0x03,
        0x02, 0x00, 0x01, 0x06, 0x06, 0x01, 0x7f, 0x00, 0x41, 0x00, 0x0b, 0x07,
        0x46, 0x04, 0x13, 0x5f, 0x5f, 0x77, 0x61, 0x73, 0x6d, 0x5f, 0x61, 0x70,
        0x70, 0x6c, 0x79, 0x5f, 0x72, 0x65, 0x6c, 0x6f, 0x63, 0x73, 0x00, 0x00,
        0x08, 0x62, 0x69, 0x6e, 0x6f, 0x6d, 0x69, 0x61, 0x6c, 0x00, 0x01, 0x0c,
        0x5f, 0x5f, 0x64, 0x73, 0x6f, 0x5f, 0x68, 0x61, 0x6e, 0x64, 0x6c, 0x65,
        0x03, 0x00, 0x12, 0x5f, 0x5f, 0x70, 0x6f, 0x73, 0x74, 0x5f, 0x69, 0x6e,
        0x73, 0x74, 0x61, 0x6e, 0x74, 0x69, 0x61, 0x74, 0x65, 0x00, 0x00, 0x0a,
        0x4f, 0x02, 0x03, 0x00, 0x01, 0x0b, 0x49, 0x01, 0x04, 0x7f, 0x41, 0x01,
        0x21, 0x02, 0x02, 0x40, 0x20, 0x01, 0x45, 0x0d, 0x00, 0x20, 0x00, 0x20,
        0x01, 0x46, 0x0d, 0x00, 0x03, 0x40, 0x20, 0x00, 0x41, 0x7f, 0x6a, 0x22,
        0x03, 0x20, 0x01, 0x10, 0x01, 0x20, 0x02, 0x6a, 0x21, 0x02, 0x20, 0x01,
        0x41, 0x7f, 0x6a, 0x22, 0x04, 0x45, 0x0d, 0x01, 0x20, 0x00, 0x20, 0x01,
        0x47, 0x21, 0x05, 0x20, 0x04, 0x21, 0x01, 0x20, 0x03, 0x21, 0x00, 0x20,
        0x05, 0x0d, 0x00, 0x0b, 0x0b, 0x20, 0x02, 0x0b
};
unsigned int binom_c_wasm_len = 200;
```

### Testing code
```c++
extern "C" void app_main(void) {
    printf("\nWasm3 v" M3_VERSION " on ESP32, build " __DATE__ " " __TIME__ "\n");
    printf("|Input|WASM|NATIVE|\n|---|---|---|\n");
    for (int i = 20; i < 30; i++) {
        for (int j = 1; j < i; j++) {
            int64_t start_wasm = esp_timer_get_time();
            run_wasm(i, j);
            int64_t end_wasm = esp_timer_get_time();

            int64_t duration_wasm = (end_wasm - start_wasm) / 1000;

            int64_t start_native = esp_timer_get_time();
            long value = binomial(i, j);
            int64_t end_native = esp_timer_get_time();
//            printf("Result: %ld\n", value);
            int64_t duration_native = (end_native - start_native) / 1000;

            printf("|(%d,%d)|%lld|%lld|\n", i, j, duration_wasm, duration_native);
        }
    }
    sleep(10);
    printf("Restarting...\n\n\n");
    esp_restart();
}
```

## Results
`Wasm3 v0.4.6 on ESP32, build Feb 10 2020 15:04:22`
|Input|WASM|NATIVE|
|---|---|---|
|(20,1)|3|0|
|(20,2)|1|0|
|(20,3)|6|0|
|(20,4)|25|0|
|(20,5)|82|2|
|(20,6)|204|4|
|(20,7)|410|9|
|(20,8)|669|15|
|(20,9)|895|19|
|(20,10)|988|22|
|(20,11)|902|20|
|(20,12)|679|15|
|(20,13)|419|9|
|(20,14)|210|4|
|(20,15)|85|1|
|(20,16)|27|0|
|(20,17)|6|0|
|(20,18)|1|0|
|(20,19)|0|0|
|(21,1)|0|0|
|(21,2)|1|0|
|(21,3)|7|0|
|(21,4)|31|0|
|(21,5)|107|2|
|(21,6)|286|6|
|(21,7)|614|14|
|(21,8)|1079|24|
|(21,9)|1564|35|
|(21,10)|1883|41|
|(21,11)|1889|42|
|(21,12)|1580|35|
|(21,13)|1098|24|
|(21,14)|630|14|
|(21,15)|295|6|
|(21,16)|111|2|
|(21,17)|33|0|
|(21,18)|8|0|


#### Notice
 ⚠️ This architecture/compiler currently fails to perform TCO (Tail Call Optimization/Elimination), which leads to sub-optimal interpreter behaviour (intense native stack usage, lower performance). There are plans to improve this in future 🦄.